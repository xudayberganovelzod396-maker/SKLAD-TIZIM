<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SKLAD TIZIMI - Bosh sahifa</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 24px;
        }
        
        .header-right {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .user-info {
            font-size: 14px;
            display: none;
        }
        
        /* .user-info .role { ... } removed */
        
        .profile-btn {
            background: rgba(255,255,255,0.3);
            color: white;
            border: 1px solid white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .profile-btn:hover {
            background: rgba(255,255,255,0.5);
        }
        
        .profile-menu {
            position: absolute;
            top: 55px;
            right: 0;
            background: white;
            border-radius: 5px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            min-width: 180px;
            display: none;
            z-index: 1001;
            overflow: hidden;
        }
        
        .profile-menu.show {
            display: block;
        }
        
        .profile-menu-item {
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #333;
            text-decoration: none;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: all 0.2s;
        }
        
        .profile-menu-item:last-child {
            border-bottom: none;
        }
        
        .profile-menu-item:hover {
            background: #f5f5f5;
        }
        
        .logout-btn-header {
            background: rgba(255,255,255,0.3);
            color: white;
            border: 1px solid white;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }
        
        .logout-btn-header:hover {
            background: rgba(255,255,255,0.5);
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow: auto;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            padding: 30px;
        }
        
        .profile-section {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            border-top: 4px solid #667eea;
        }
        
        .profile-section h3 {
            margin: 0 0 20px 0;
            color: #333;
            background: #667eea;
            color: white;
            padding: 10px 15px;
            margin: -20px -20px 20px -20px;
            border-radius: 4px 4px 0 0;
        }
        
        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            margin: 0 auto 20px;
        }
        
        .profile-info {
            text-align: center;
        }
        
        .profile-info-item {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }
        
        .profile-info-label {
            font-size: 12px;
            color: #999;
            text-transform: uppercase;
            font-weight: 600;
        }
        
        .profile-info-value {
            font-size: 14px;
            color: #333;
            margin-top: 5px;
        }
        
        .form-group-profile {
            margin-bottom: 15px;
        }
        
        .form-group-profile label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
            font-size: 13px;
        }
        
        .form-group-profile input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 13px;
        }
        
        .form-group-profile input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .password-hint {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
        
        .btn-change-password {
            width: 100%;
            padding: 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 15px;
        }
        
        .btn-change-password:hover {
            background: #764ba2;
        }
        
        .activity-text {
            color: #666;
            font-size: 13px;
            line-height: 1.6;
        }
        
        .btn-close-modal {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            color: #222;
            border: none;
            width: auto;
            height: auto;
            border-radius: 0;
            cursor: pointer;
            font-size: 28px;
        }
        
        .btn-close-modal:hover {
            background: #ff5252;
        }
        
        @media (max-width: 900px) {
            .modal-content {
                grid-template-columns: 1fr;
                max-width: 95%;
            }
        }
        
        button.add-btn {
            background: #27ae60;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        button.add-btn:hover {
            background: #219150;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        #adminSection {
            display: none;
        }
        
        #adminSection.show {
            display: flex;
        }
        
        #adminSection h2 {
            margin-top: 0;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.3);
            display: none;
            z-index: 999;
        }
        
        .overlay.show {
            display: block;
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 15px;
            border-bottom: none;
            padding-bottom: 0;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }
        
        .form-group {
            position: relative;
        }
        
        .form-group input {
            width: 100%;
            padding: 22px 10px 10px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 15px;
            transition: all 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group input::placeholder {
            color: transparent;
        }
        
        .form-group label {
            position: absolute;
            top: 18px;
            left: 12px;
            font-size: 14px;
            color: #999;
            pointer-events: none;
            transition: all 0.3s ease;
            background: white;
            padding: 0 4px;
        }
        
        .form-group input:focus + label,
        .form-group input:not(:placeholder-shown) + label {
            top: 2px;
            left: 8px;
            font-size: 12px;
            color: #667eea;
            font-weight: 600;
            background: white;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }
        
        .search-box {
            margin-bottom: 0;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .table thead {
            background: #f0f0f0;
        }
        
        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .table tr:hover {
            background: #f9f9f9;
        }
        
        .batch-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 7px 12px 7px 14px;
            margin-bottom: 0px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            overflow: hidden;
            position: relative;
            transition: all 0.3s;
        }
        
        .batch-item.sliding {
            animation: slideOut 0.5s ease-in forwards;
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .batch-content {
            flex: 1;
        }
        
        .batch-title {
            font-weight: 700;
            color: #222;
            margin-bottom: 5px;
            font-size: 1.35rem;
        }
        
        .batch-meta {
            display: grid;
            grid-template-columns: auto auto auto;
            gap: 7px;
            font-size: 1.15rem;
            color: #222;
        }
        
        .batch-meta span {
            display: flex;
            gap: 5px;
            font-size: 1.13rem;
        }
        
        .batch-meta strong {
            color: #111;
            font-size: 1.13rem;
            font-weight: 700;
        }
        
        .batch-actions {
            display: flex;
            gap: 10px;
            margin-left: 15px;
        }
        
        .btn-slide {
            background: #ff6b6b;
            padding: 8px 15px;
            font-size: 12px;
            cursor: pointer;
            border-radius: 3px;
        }
        
        .btn-slide:hover {
            background: #ff5252;
        }
        
        .hidden {
            display: none;
        }
        
        .alert {
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        
        .empty-state svg {
            width: 60px;
            height: 60px;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                gap: 10px;
            }
            
            .batch-item {
                flex-direction: column;
                gap: 10px;
            }
            
            .batch-actions {
                width: 100%;
                margin-left: 0;
            }
            
            .batch-meta {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>üè≠ SKLAD TIZIMI</h1>
            <div class="header-right">
                <div class="user-info">
                    üë§ <strong id="username"></strong>
                    <!-- <span class="role" id="role"></span> -->
                </div>
                <div style="position: relative; display: inline-block;">
                    <button class="profile-btn" id="profileBtn">üë§</button>
                    <div class="profile-menu" id="profileMenu">
                        <div class="profile-menu-item" id="profileItem">
                            <span>üë§</span>
                            <span>Profil</span>
                        </div>
                    </div>
                </div>
                <a href="/logout" class="logout-btn-header">
                    Chiqish ‚Üí
                </a>
            </div>
        </div>
    </div>
    
    <div class="overlay" id="overlay"></div>
    
    <!-- Profile Modal -->
    <div class="modal" id="profileModal">
        <div class="modal-content">
            <button class="btn-close-modal" onclick="closeProfileModal()">‚úï</button>
            
            <!-- Left Section: User Info -->
            <div class="profile-section">
                <h3>üë§ Foydalanuvchi</h3>
                <div class="profile-avatar">üë§</div>
                <div class="profile-info">
                    <div class="profile-info-item">
                        <div class="profile-info-label">üë§ –§–ò–û</div>
                        <div class="profile-info-value" id="userFullName">Nomalarim</div>
                    </div>
                    <div class="profile-info-item">
                        <div class="profile-info-label">üìß E-Mail</div>
                        <div class="profile-info-value" id="userEmail">email@example.com</div>
                    </div>
                    <div class="profile-info-item">
                        <div class="profile-info-label">üë§ Nomi</div>
                        <div class="profile-info-value" id="userFirstName">-</div>
                    </div>
                    <div class="profile-info-item">
                        <div class="profile-info-label">üë§ Familiyasi</div>
                        <div class="profile-info-value" id="userLastName">-</div>
                    </div>
                </div>
            </div>
            
            <!-- Middle Section: Change Password -->
            <div class="profile-section">
                <h3>üîê Parolni O'zgartirish</h3>
                <form id="changePasswordForm">
                    <div class="form-group-profile">
                        <label for="currentPassword">Joriy parol</label>
                        <input type="password" id="currentPassword" placeholder="Joriy parolni kiriting">
                    </div>
                    <div class="form-group-profile">
                        <label for="newPassword">Yangi parol</label>
                        <input type="password" id="newPassword" placeholder="Yangi parolni kiriting">
                    </div>
                    <div class="form-group-profile">
                        <label for="confirmPassword">Parolni tasdiqlash</label>
                        <input type="password" id="confirmPassword" placeholder="Parolni qayta kiriting">
                        <div class="password-hint">5 dan 50 ta belgigacha - raqamlar, harflar va belgilar</div>
                    </div>
                    <button type="submit" class="btn-change-password">üîê PAROLNI O'ZGARTIRISH</button>
                </form>
            </div>
            
            <!-- Right Section: Activity -->
            <div class="profile-section">
                <h3>üìä Faollik</h3>
                <div class="activity-text">
                    <strong>Qidiruv qo'shni yangilari:</strong><br>
                    Sizning tizimda yo'q hujjatlar va notiqtalanmagan tashriflar bo'yicha bilgilash olish uchun qidsov birlanmalarini o'rnatishni talab qiladi.
                    <br><br>
                    <strong>Oxirgi kirish:</strong><br>
                    <span id="lastLogin">-</span>
                    <br><br>
                    <strong>Jami partiyalar:</strong><br>
                    <span id="totalBatches">0</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container">
        <!-- Add Batch Modal -->
        <div id="adminSection" class="modal">
            <div class="modal-content" style="max-width: 650px; width: 100%; display: block; padding: 18px 36px 40px 36px; position: relative;">
                                <button class="btn-close-modal" id="closeAddBatchModal" style="position: absolute; top: 10px; right: 10px; background: none; border: none; color: #333; font-size: 28px; cursor: pointer;">
                                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                        <path d="M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                </button>
                <h2 style="margin-top: 0; margin-bottom: 22px;">‚ûï Yangi Partiya Qo'shish</h2>
                <div id="addAlert"></div>
                <form id="addBatchForm">
                    <div class="form-row">
                        <div class="form-group">
                            <input type="text" id="productName" placeholder="Kabel" required>
                            <label for="productName">Mahsulot Nomi *</label>
                        </div>
                        <div class="form-group">
                            <input type="text" id="batchCode" placeholder="P-2025-001" required>
                            <label for="batchCode">Partiya Kodi *</label>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <input type="number" id="quantity_sht" placeholder="Miqdor (sht)" min="0" style="width:100%;">
                            <label for="quantity_sht">Miqdor (sht)</label>
                        </div>
                        <div class="form-group">
                            <input type="number" id="quantity_kg" placeholder="Miqdor (kg)" min="0" step="any" style="width:100%;">
                            <label for="quantity_kg">Miqdor (kg)</label>
                        </div>
                        <div class="form-group">
                            <input type="text" id="location" placeholder="A-1-1" required>
                            <label for="location">Joy (A-1-1 format) *</label>
                        </div>
                        <div class="form-group">
                            <input type="text" id="comment" placeholder="Izox" style="width:100%;">
                            <label for="comment">Izox</label>
                        </div>
                    </div>
                    <button type="submit">‚úÖ Saqlash</button>
                </form>
            </div>
        </div>
        
        <!-- Search & Add Section -->
        <div class="section">
            <h2>üîé Qidiruv</h2>
            <div style="display: flex; gap: 10px; align-items: flex-end;">
                <div style="flex: 1;">
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="Partiya kodi, mahsulot nomi yoki joy bo'yicha qidiruv...">
                    </div>
                </div>
                <button id="addFormBtn" class="add-btn" style="display: none;">
                    <span>+</span>
                    <span>Qo'shish</span>
                </button>
            </div>
        </div>
        
        <!-- Batches List -->
                <div class="section">
                        <div style="display: flex; align-items: center; justify-content: space-between; gap: 16px;">
                            <h2>üì¶ Partiyalar Ro'yxati</h2>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span id="totalInfo" style="font-size: 16px; font-weight: normal; background: #fff; border: 1px solid #dedede; border-radius: 6px; padding: 4px 18px; margin-left: 10px;"></span>
                                <button id="showMatrixBtn" style="background: #bdbdbd; color: #222; border: none; padding: 2px 6px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; height: 36px; min-width: 36px; min-height: 36px; width: 36px; justify-content: center;">
                                    <span style="width: 28px; height: 28px; background: none; border-radius: 0; display: flex; align-items: center; justify-content: center; padding: 0; margin: 0;">
                                        <svg width="24" height="24" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <rect x="4" y="4" width="24" height="24" stroke="#222" stroke-width="3" stroke-dasharray="6,4" fill="none"/>
                                            <line x1="16" y1="4" x2="16" y2="28" stroke="#222" stroke-width="3" stroke-dasharray="6,4"/>
                                            <line x1="4" y1="16" x2="28" y2="16" stroke="#222" stroke-width="3" stroke-dasharray="6,4"/>
                                        </svg>
                                    </span>
                                </button>
                            </div>
                        </div>
                        <div id="batchesAlert"></div>
                        <div id="batchesList"></div>
                        <div id="pagination" style="display: flex; gap: 6px; margin-top: 18px; justify-content: center;"></div>
                        <div id="emptyState" class="empty-state" style="display: none;">
                            üì≠ Hali partiya qo'shilmagan
                        </div>
                </div>
                <div id="matrixModal" class="modal">
                        <div class="modal-content" style="max-width: 820px; width: 100%; display: block; position: relative; padding: 48px 60px 48px 60px; border-radius: 16px; background: #fff; box-shadow: 0 8px 40px #ffe60033, 0 2px 16px #00000014;">
                            <button class="btn-close-modal" id="closeMatrixModal" style="position: absolute; top: 18px; right: 24px; background: none; border: none; color: #333; font-size: 34px; cursor: pointer;">‚úï</button>
                            <h2 style="margin-bottom: 24px; font-size: 1.45rem; font-weight: 700; color: #222; text-align: left;">Qatorlar holati</h2>
                            <div id="rowsMatrix" style="margin: 24px 0; border: 4px solid #ffe600; border-radius: 12px; padding: 24px 0 24px 0; display: flex; justify-content: center; align-items: center; background: #fff; box-shadow: 0 4px 24px #ffe60022;">
                                <div style="display: flex; justify-content: center; align-items: center; min-width: 640px; min-height: 440px; background: #f1f1ee; border-radius: 22px; box-shadow: 0 2px 16px #ffe60033; padding: 36px 32px;">
                                    <table id="matrixAll" style="border-collapse: collapse; font-size: 24px; background: #f5f4f1; border-radius: 16px;">
                                    </table>
                                </div>
                            </div>
                        </div>
                </div>
            <div id="batchesAlert"></div>
            <div id="batchesList"></div>
            <div id="pagination" style="display: flex; gap: 6px; margin-top: 18px; justify-content: center;"></div>
            <div id="emptyState" class="empty-state" style="display: none;">
                üì≠ Hali partiya qo'shilmagan
            </div>
            <!-- Qatorlar holati modal -->
            <div id="rowsStatusModal" class="modal">
                <div class="modal-content" style="max-width: 500px; width: 100%; display: block; position: relative; padding: 28px 36px 36px 36px;">
                    <button class="btn-close-modal" id="closeRowsStatusModal" style="position: absolute; top: 10px; right: 10px; background: none; border: none; color: #333; font-size: 28px; cursor: pointer;">‚úï</button>
                    <h2 style="margin-bottom: 20px;">Qatorlar holati</h2>
                    <div id="rowsStatusList"></div>
                </div>
            </div>
        </div>
        <!-- Chiqarish Modal -->
        <div id="removeModal" class="modal">
            <div class="modal-content" style="max-width: 350px; width: 100%; display: block; position: relative;">
                <button id="closeRemoveModal" style="position: absolute; top: 10px; right: 10px; background: none; border: none; color: #333; font-size: 28px; cursor: pointer;">‚úï</button>
                <h2 style="margin-bottom: 20px;">‚Üí Chiqarish</h2>
                <div id="removeModalInfo" style="margin-bottom: 10px;"></div>
                <form id="removeForm">
                    <label>Nechta chiqarilsin?</label>
                    <input type="number" id="removeQtyInput" min="1" required style="width: 100%; padding: 8px; margin: 10px 0 10px 0; border-radius: 5px; border: 1px solid #ddd; font-size: 16px;">
                    <label style="margin-top:10px;">Necha kg chiqarilsin?</label>
                    <input type="number" id="removeKgInput" min="0" step="0.01" style="width: 100%; padding: 8px; margin: 10px 0 20px 0; border-radius: 5px; border: 1px solid #ddd; font-size: 16px;">
                    <button type="submit" class="btn-slide" style="width: 100%;">‚Üí Chiqarish</button>
                </form>
            </div>
        </div>
    </div>
    
        <script>
        // Matritsa qiymatlari va band/bo‚Äòsh holat (demo, backenddan keladi)
        const matrix = {
            A: [[4,3,2,1],[4,3,2,1],[4,3,2,1],[4,3,2,1],[4,3,2,1],[4,3,2,1],[4,3,2,1],[4,3,2,1],[4,3,2,1]],
            B: [[4,3,2,1],[4,3,2,1],[4,3,2,1],[4,3,2,1],[4,3,2,1],[4,3,2,1],[4,3,2,1],[4,3,2,1],[4,3,2,1]],
            C: [[4,3,2,1],[4,3,2,1],[4,3,2,1],[4,3,2,1],[4,3,2,1],[4,3,2,1],[4,3,2,1],[4,3,2,1],[4,3,2,1]]
        };
        // Kataklar holati backenddan keladi
        let busyCells = {
          A: Array(9).fill().map(() => Array(4).fill(false)),
          B: Array(9).fill().map(() => Array(4).fill(false)),
          C: Array(9).fill().map(() => Array(4).fill(false)),
        };

            // Katakni band qilish (yangi partiya qo'shilganda)
            function setCellBusy(location) {
                // location: "A-1-4"
                if (!location) return;
                const [sector, row, cell] = location.split('-');
                if (busyCells[sector] && busyCells[sector][parseInt(row)-1]) {
                    busyCells[sector][parseInt(row)-1][parseInt(cell)-1] = true;
                    renderMatrix();
                }
            }

            // Katakni bo'shatish (mahsulot chiqarilganda)
            function setCellFree(location) {
                if (!location) return;
                const [sector, row, cell] = location.split('-');
                if (busyCells[sector] && busyCells[sector][parseInt(row)-1]) {
                    busyCells[sector][parseInt(row)-1][parseInt(cell)-1] = false;
                    renderMatrix();
                }
            }

        async function fetchMatrixStatus() {
            try {
                const res = await fetch('/api/rows_matrix_status');
                if (res.ok) {
                    const data = await res.json();
                    // 'busy' => true, 'free' => false
                    for (const sector of ['A','B','C']) {
                        for (let i = 0; i < 9; i++) {
                            for (let j = 0; j < 4; j++) {
                                busyCells[sector][i][j] = (data[sector][i][j] === 'busy');
                            }
                        }
                    }
                }
            } catch (e) {}
        }
        function renderMatrix() {
            const table = document.querySelector('#rowsMatrix table');
            // Jadval sarlavhasi
            table.innerHTML = `
                <tr>
                    <th style="background:#f8f8f8;">‚Ññ</th>
                    <th colspan="4" style="background:yellow;">A</th>
                    <th style="background:#f8f8f8;">‚Ññ</th>
                    <th colspan="4" style="background:yellow;">B</th>
                    <th style="background:#f8f8f8;">‚Ññ</th>
                    <th colspan="4" style="background:yellow;">C</th>
                </tr>
                <tr>
                    <th style="background:#f8f8f8;"></th>
                    <th style="background: #eee;">1</th>
                    <th style="background: #eee;">2</th>
                    <th style="background: #eee;">3</th>
                    <th style="background: #eee;">4</th>
                    <th style="background:#f8f8f8;"></th>
                    <th style="background: #eee;">1</th>
                    <th style="background: #eee;">2</th>
                    <th style="background: #eee;">3</th>
                    <th style="background: #eee;">4</th>
                    <th style="background:#f8f8f8;"></th>
                    <th style="background: #eee;">1</th>
                    <th style="background: #eee;">2</th>
                    <th style="background: #eee;">3</th>
                    <th style="background: #eee;">4</th>
                </tr>
            `;
            for (let i = 0; i < 9; i++) {
                const tr = document.createElement('tr');
                // A sektori
                tr.innerHTML += `<td style='background:#f8f8f8;'>${i+1}</td>`;
                for (let j = 0; j < 4; j++) {
                    tr.innerHTML += `<td style=\"background:${busyCells['A'][i][j] ? '#e04a6a' : '#27ae60'};color:#fff;text-align:center;font-weight:bold;min-width:32px;\">${matrix['A'][i][j]}</td>`;
                }
                // B sektori
                tr.innerHTML += `<td style='background:#f8f8f8;'>${i+1}</td>`;
                for (let j = 0; j < 4; j++) {
                    tr.innerHTML += `<td style=\"background:${busyCells['B'][i][j] ? '#e04a6a' : '#27ae60'};color:#fff;text-align:center;font-weight:bold;min-width:32px;\">${matrix['B'][i][j]}</td>`;
                }
                // C sektori
                tr.innerHTML += `<td style='background:#f8f8f8;'>${i+1}</td>`;
                for (let j = 0; j < 4; j++) {
                    tr.innerHTML += `<td style=\"background:${busyCells['C'][i][j] ? '#e04a6a' : '#27ae60'};color:#fff;text-align:center;font-weight:bold;min-width:32px;\">${matrix['C'][i][j]}</td>`;
                }
                table.appendChild(tr);
            }
        }
        // Modal ochish va yopish
        document.addEventListener('DOMContentLoaded', function() {
            const showMatrixBtn = document.getElementById('showMatrixBtn');
            const matrixModal = document.getElementById('matrixModal');
            const closeMatrixModal = document.getElementById('closeMatrixModal');
            showMatrixBtn.addEventListener('click', async function() {
                await fetchMatrixStatus();
                renderMatrix();
                matrixModal.classList.add('show');
            });
            closeMatrixModal.addEventListener('click', function() {
                matrixModal.classList.remove('show');
            });
            window.addEventListener('click', function(e) {
                if (e.target === matrixModal) {
                    matrixModal.classList.remove('show');
                }
            });
        });
        // Qatorlar holati uchun demo ma'lumot (backenddan keladi)

        let rowsStatus = [];

        async function fetchRowsStatus() {
            try {
                const response = await fetch('/api/rows_status');
                if (!response.ok) throw new Error('Serverdan xato javob');
                rowsStatus = await response.json();
            } catch (e) {
                rowsStatus = [];
            }
        }

        // Modalni ochish
        document.addEventListener('DOMContentLoaded', function() {
            const showRowsStatusBtn = document.getElementById('showRowsStatusBtn');
            const rowsStatusModal = document.getElementById('rowsStatusModal');
            const closeRowsStatusModal = document.getElementById('closeRowsStatusModal');
            showRowsStatusBtn.addEventListener('click', async function() {
                await fetchRowsStatus();
                renderRowsStatus();
                rowsStatusModal.classList.add('show');
            });
            closeRowsStatusModal.addEventListener('click', function() {
                rowsStatusModal.classList.remove('show');
            });
            window.addEventListener('click', function(e) {
                if (e.target === rowsStatusModal) {
                    rowsStatusModal.classList.remove('show');
                }
            });
        });

        // Qatorlar holatini chizish
        function renderMatrix() {
            // 1. Barcha kataklarni bo'sh deb belgila
            busyCells = {
                A: Array(9).fill().map(() => Array(4).fill(false)),
                B: Array(9).fill().map(() => Array(4).fill(false)),
                C: Array(9).fill().map(() => Array(4).fill(false)),
            };
            // 2. Barcha partiyalarni (allBatches) ko'rib chiqib, band kataklarni belgila
            if (window.allBatches && Array.isArray(window.allBatches)) {
                window.allBatches.forEach(batch => {
                    if (batch.location) {
                        const match = batch.location.match(/([ABC])-([1-9])-([1-4])/);
                        if (match) {
                            const sector = match[1];
                            const row = parseInt(match[2], 10) - 1;
                            const col = parseInt(match[3], 10) - 1;
                            busyCells[sector][row][col] = true;
                        }
                    }
                });
            }
            const table = document.getElementById('matrixAll');
            let html = '';
            // 1-qator: sektor sarlavhalari (A, B, C) faqat
            html += `<tr>`;
            html += `<th style='background:#f8f8f8; min-width: 36px; min-height: 36px; padding: 10px 12px; font-size: 22px; border-top-left-radius: 18px;'>‚Ññ</th>`;
            for (let s = 0; s < 3; s++) {
                if (s > 0) html += `<th style='min-width: 18px; background: #fffde7; border: none;'></th>`;
                html += `<th colspan='4' style='background: #ffe600; color: #222; font-weight: 700; font-size: 22px; padding: 10px 0; border-radius: 0 0 0 0;'>${String.fromCharCode(65 + s)}</th>`;
            }
            html += `</tr>`;
            // 3-11 qatorlar: qiymatlar
            for (let i = 0; i < 9; i++) {
                html += `<tr>`;
                html += `<td style='background:#f8f8f8; min-width: 36px; min-height: 36px; padding: 10px 12px; font-size: 22px; text-align: center;'>${i + 1}</td>`;
                for (let s = 0; s < 3; s++) {
                    if (s > 0) html += `<td style='min-width: 18px; background: #fffde7; border: none;'></td>`;
                    for (let n = 0; n < 4; n++) {
                        // 1 2 3 4 chapdan o'ngga
                        const colIdx = n;
                        html += `<td style=\"background:${busyCells[String.fromCharCode(65+s)][i][colIdx] ? '#e04a6a' : '#27ae60'};color:#fff;text-align:center;font-weight:bold;min-width:36px;min-height:36px;padding:10px 18px;font-size:22px; border-left:2px solid #fff; border-right:2px solid #fff; border-top: 1.5px solid #fff; border-bottom: 1.5px solid #fff;\">${colIdx+1}</td>`;
                    }
                }
                html += `</tr>`;
            }
            table.innerHTML = html;
                                        function renderSectorMatrix(sectorName, sectorMatrix, sectorBusy, containerId) {
                                            const container = document.getElementById(containerId);
                                            let html = `<table style=\"border-collapse: collapse; font-size: 16px;\">`;
                                            html += `<tr><th style='background:#f8f8f8; min-width: 22px; min-height: 22px; padding: 2px 6px; font-size: 16px;'>‚Ññ</th><th colspan='4' style='background:yellow; min-width: 88px; min-height: 22px; font-size: 16px; padding: 2px 6px;'>${sectorName}</th></tr>`;
                                            html += `<tr><th style='background:#f8f8f8; min-width: 22px; min-height: 22px; padding: 2px 6px; font-size: 16px;'></th>`;
                                            for (let j = 0; j < 4; j++) {
                                                html += `<th style='background:#eee; min-width: 22px; min-height: 22px; padding: 2px 6px; font-size: 16px;'>${j+1}</th>`;
                                            }
                                            html += `</tr>`;
                                            for (let i = 0; i < 9; i++) {
                                                html += `<tr>`;
                                                html += `<td style='background:#f8f8f8; min-width: 22px; min-height: 22px; padding: 2px 6px; font-size: 16px;'>${i+1}</td>`;
                                                for (let j = 0; j < 4; j++) {
                                                    html += `<td style=\"background:${sectorBusy[i][j] ? '#e04a6a' : '#27ae60'};color:#fff;text-align:center;font-weight:bold;min-width:22px;min-height:22px;padding:2px 6px;font-size:16px;\">${sectorMatrix[i][j]}</td>`;
                                                }
                                                html += `</tr>`;
                                            }
                                            html += `</table>`;
                                            container.innerHTML = html;
                                        }
                                function renderSectorMatrix(sectorName, sectorMatrix, sectorBusy, containerId) {
                                    const container = document.getElementById(containerId);
                                    let html = `<table style="border-collapse: collapse; font-size: 28px;">`;
                                    html += `<tr><th style='background:#f8f8f8; min-width: 48px; min-height: 48px; padding: 12px; font-size: 28px;'>‚Ññ</th><th colspan='4' style='background:yellow; min-width: 192px; min-height: 48px; font-size: 28px; padding: 12px;'>${sectorName}</th></tr>`;
                                    html += `<tr><th style='background:#f8f8f8; min-width: 48px; min-height: 48px; padding: 12px; font-size: 28px;'></th>`;
                                    for (let j = 0; j < 4; j++) {
                                        html += `<th style='background:#eee; min-width: 48px; min-height: 48px; padding: 12px; font-size: 28px;'>${j+1}</th>`;
                                    }
                                    html += `</tr>`;
                                    for (let i = 0; i < 9; i++) {
                                        html += `<tr>`;
                                        html += `<td style='background:#f8f8f8; min-width: 48px; min-height: 48px; padding: 12px; font-size: 28px;'>${i+1}</td>`;
                                        for (let j = 0; j < 4; j++) {
                                            html += `<td style="background:${sectorBusy[i][j] ? '#e04a6a' : '#27ae60'};color:#fff;text-align:center;font-weight:bold;min-width:48px;min-height:48px;padding:12px;font-size:28px;">${sectorMatrix[i][j]}</td>`;
                                        }
                                        html += `</tr>`;
                                    }
                                    html += `</table>`;
                                    container.innerHTML = html;
                                }
                        function renderSectorMatrix(sectorName, sectorMatrix, sectorBusy, containerId) {
                            const container = document.getElementById(containerId);
                            let html = `<table style="border-collapse: collapse; font-size: 28px;">`;
                            html += `<tr><th style='background:#f8f8f8; min-width: 48px; min-height: 48px; padding: 12px; font-size: 28px;'>‚Ññ</th><th colspan='4' style='background:yellow; min-width: 192px; min-height: 48px; font-size: 28px; padding: 12px;'>${sectorName}</th></tr>`;
                            html += `<tr><th style='background:#f8f8f8; min-width: 48px; min-height: 48px; padding: 12px; font-size: 28px;'></th>`;
                            for (let j = 0; j < 4; j++) {
                                html += `<th style='background:#eee; min-width: 48px; min-height: 48px; padding: 12px; font-size: 28px;'>${j+1}</th>`;
                            }
                            html += `</tr>`;
                            for (let i = 0; i < 9; i++) {
                                html += `<tr>`;
                                html += `<td style='background:#f8f8f8; min-width: 48px; min-height: 48px; padding: 12px; font-size: 28px;'>${i+1}</td>`;
                                for (let j = 0; j < 4; j++) {
                                    html += `<td style="background:${sectorBusy[i][j] ? '#e04a6a' : '#27ae60'};color:#fff;text-align:center;font-weight:bold;min-width:48px;min-height:48px;padding:12px;font-size:28px;">${sectorMatrix[i][j]}</td>`;
                                }
                                html += `</tr>`;
                            }
                            html += `</table>`;
                            container.innerHTML = html;
                        }
                function renderSectorMatrix(sectorName, sectorMatrix, sectorBusy, containerId) {
                    const container = document.getElementById(containerId);
                    let html = `<table style=\"border-collapse: collapse; font-size: 28px;\">`;
                    html += `<tr><th style='background:#f8f8f8; min-width: 48px; min-height: 48px; padding: 12px; font-size: 28px;'>‚Ññ</th><th colspan='4' style='background:yellow; min-width: 192px; min-height: 48px; font-size: 28px; padding: 12px;'>${sectorName}</th></tr>`;
                    html += `<tr><th style='background:#f8f8f8; min-width: 48px; min-height: 48px; padding: 12px; font-size: 28px;'></th>`;
                    for (let j = 0; j < 4; j++) {
                        html += `<th style='background:#eee; min-width: 48px; min-height: 48px; padding: 12px; font-size: 28px;'>${j+1}</th>`;
                    }
                    html += `</tr>`;
                    for (let i = 0; i < 9; i++) {
                        html += `<tr>`;
                        html += `<td style='background:#f8f8f8; min-width: 48px; min-height: 48px; padding: 12px; font-size: 28px;'>${i+1}</td>`;
                        for (let j = 0; j < 4; j++) {
                            html += `<td style=\"background:${sectorBusy[i][j] ? '#e04a6a' : '#27ae60'};color:#fff;text-align:center;font-weight:bold;min-width:48px;min-height:48px;padding:12px;font-size:28px;\">${sectorMatrix[i][j]}</td>`;
                        }
                        html += `</tr>`;
                    }
                    html += `</table>`;
                    container.innerHTML = html;
                }
        }

        // endi kerak emas
        // let currentRole = '';
        let allBatches = [];
        let currentPage = 1;
        const pageSize = 7;

        // ==================== FETCH WITH AUTH ====================
        async function fetchWithAuth(url, options) {
            try {
                const response = await fetch(url, options);
                if (response.status === 401 || response.status === 403) {
                    window.location.href = '/login';
                    return null;
                }
                // Agar JSON emas, HTML qaytsa, xabar ko'rsatish
                const contentType = response.headers.get('content-type') || '';
                if (!contentType.includes('application/json')) {
                    showAlert && showAlert('batchesAlert', '‚ùå Xato: Serverdan noto‚Äòg‚Äòri javob keldi yoki sessiya tugagan!', 'error');
                    return null;
                }
                return response;
            } catch (err) {
                showAlert && showAlert('batchesAlert', '‚ùå Xato: ' + err.message, 'error');
                return null;
            }
        }

        // ==================== INIT ====================
        window.addEventListener('load', async () => {
            await loadUser();
            await loadBatches();
        });
        
        // ==================== USER INFO ====================
        async function loadUser() {
            try {
                const response = await fetchWithAuth('/api/user');
                if (!response) return;
                const user = await response.json();

                document.getElementById('username').textContent = user.username;
                // document.getElementById('role').textContent = user.role === 'admin' ? 'üîë ADMIN' : 'üëÅ KO\'RUVCHI';
                // currentRole = user.role;

                // Profile menu toggle
                const profileBtn = document.getElementById('profileBtn');
                const profileMenu = document.getElementById('profileMenu');
                profileBtn.addEventListener('click', () => {
                    profileMenu.classList.toggle('show');
                });

                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.profile-btn') && !e.target.closest('.profile-menu')) {
                        profileMenu.classList.remove('show');
                    }
                    // Modal yopish uchun overlay-ga bosish
                    if (e.target.id === 'profileModal') {
                        closeProfileModal();
                    }
                });

                // Profile item click
                document.getElementById('profileItem').addEventListener('click', () => {
                    showProfile(user);
                    profileMenu.classList.remove('show');
                });
                // Password form submit
                const passwordForm = document.getElementById('changePasswordForm');
                if (passwordForm) {
                    passwordForm.addEventListener('submit', changePassword);
                }

                document.getElementById('addFormBtn').style.display = 'flex';
                document.getElementById('addBatchForm').addEventListener('submit', addBatch);
                // Modalni ochish va yopish
                const adminSection = document.getElementById('adminSection');
                const addFormBtn = document.getElementById('addFormBtn');
                const closeAddBatchModal = document.getElementById('closeAddBatchModal');
                addFormBtn.addEventListener('click', () => {
                    adminSection.classList.add('show');
                });
                // Modal va overlayni yopish funksiyasi
                function closeAdminModal() {
                    adminSection.classList.remove('show');
                    const overlay = document.getElementById('overlay');
                    if (overlay) overlay.classList.remove('show');
                }
                if (closeAddBatchModal) {
                    closeAddBatchModal.onclick = closeAdminModal;
                }
                const overlay = document.getElementById('overlay');
                if (overlay) {
                    overlay.addEventListener('click', closeAdminModal);
                }
                window.addEventListener('click', (e) => {
                    if (e.target === adminSection) {
                        adminSection.classList.remove('show');
                    }
                });
            } catch (error) {
                console.error('User load error:', error);
            }
        }
        
        // ==================== SHOW PROFILE ====================
        function showProfile(user) {
            const modal = document.getElementById('profileModal');
            
            if (!modal) {
                console.error('Modal topilmadi!');
                return;
            }
            
            // Fill user info
            document.getElementById('userFullName').textContent = user.username;
            document.getElementById('userEmail').textContent = 'user@sklad.uz';
            document.getElementById('userFirstName').textContent = user.username.charAt(0).toUpperCase() + user.username.slice(1);
            // document.getElementById('userLastName').textContent = user.role === 'admin' ? 'üîë ADMIN' : 'üëÅ KO\'RUVCHI';
            
            // Fetch activity
            fetchActivity();
            
            // Show modal
            modal.classList.add('show');
            console.log('Modal ochildi');
        }
        
        // ==================== FETCH ACTIVITY ====================
        async function fetchActivity() {
            try {
                const response = await fetchWithAuth('/api/user/activity');
                if (!response) return;
                const data = await response.json();

                document.getElementById('lastLogin').textContent = data.last_active;
                document.getElementById('totalBatches').textContent = data.total_batches;
            } catch (error) {
                console.error('Activity fetch error:', error);
            }
        }
        
        function closeProfileModal() {
            const modal = document.getElementById('profileModal');
            modal.classList.remove('show');
        }
        
        // ==================== CHANGE PASSWORD ====================
        async function changePassword(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Validation
            if (!currentPassword) {
                showAlert('batchesAlert', '‚ùå Joriy parolni kiriting', 'error');
                return;
            }
            
            if (newPassword.length < 5) {
                showAlert('batchesAlert', '‚ùå Parol kamida 5 ta belgi bo\'lishi kerak', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showAlert('batchesAlert', '‚ùå Yangi parollar mos kelmaydi', 'error');
                return;
            }
            
            if (currentPassword === newPassword) {
                showAlert('batchesAlert', '‚ùå Yangi parol eski parol bilan bir xil bo\'lmasligi kerak', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/user/password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('batchesAlert', '‚úÖ ' + result.message, 'success');
                    document.getElementById('changePasswordForm').reset();
                    setTimeout(() => {
                        closeProfileModal();
                    }, 2000);
                } else {
                    showAlert('batchesAlert', '‚ùå ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('batchesAlert', '‚ùå Xato: ' + error.message, 'error');
            }
        }
        
        // ==================== FORM TOGGLE ====================
        function setupFormToggle() {
            // Endi kerak emas
        }
        
        // ==================== LOAD BATCHES ====================
        async function loadBatches() {
            try {
                const response = await fetchWithAuth('/api/batches');
                if (!response) return;
                if (!response.ok) {
                    const text = await response.text();
                    showAlert('batchesAlert', 'Xato: ' + text, 'error');
                    return;
                }
                allBatches = await response.json();
                window.allBatches = allBatches;
                currentPage = 1;
                renderBatchesPage();
            } catch (error) {
                showAlert('batchesAlert', 'Xato: ' + error.message, 'error');
            }
        }
        
        // ==================== RENDER BATCHES ====================
        // ==================== PAGINATION & SEARCH STATE ====================
        let searchMode = false;
        let searchQuery = '';
        let searchTotal = 0;
        let searchResults = [];

        function renderBatchesPage(customBatches, customTotal) {
            let batches, total;
            if (searchMode && typeof customBatches !== 'undefined') {
                batches = customBatches.filter(batch => (batch.quantity_sht || 0) > 0 || (batch.quantity_kg || 0) > 0);
                total = typeof customTotal === 'number' ? customTotal : searchTotal;
            } else if (Array.isArray(customBatches)) {
                batches = customBatches.filter(batch => (batch.quantity_sht || 0) > 0 || (batch.quantity_kg || 0) > 0);
                total = batches.length;
            } else {
                batches = allBatches.filter(batch => (batch.quantity_sht || 0) > 0 || (batch.quantity_kg || 0) > 0);
                total = batches.length;
            }
            const container = document.getElementById('batchesList');
            const emptyState = document.getElementById('emptyState');
            const pagination = document.getElementById('pagination');
            // Umumiy sht va kg hisoblash
            let totalSht = 0;
            let totalKg = 0;
            batches.forEach(batch => {
                totalSht += batch.quantity_sht || 0;
                totalKg += batch.quantity_kg || 0;
            });
            // Sarlavha yoniga chiqarish
            let totalInfo = document.getElementById('totalInfo');
            const header = Array.from(document.querySelectorAll('.section h2')).find(h2 => h2.textContent.includes("Partiyalar Ro'yxati"));
            if (header) {
                if (!totalInfo) {
                    totalInfo = document.createElement('span');
                    totalInfo.id = 'totalInfo';
                    totalInfo.style.float = 'right';
                    totalInfo.style.fontSize = '16px';
                    totalInfo.style.fontWeight = 'normal';
                    totalInfo.style.background = '#fff';
                    totalInfo.style.border = '1px solid #dedede';
                    totalInfo.style.borderRadius = '6px';
                    totalInfo.style.padding = '4px 18px';
                    totalInfo.style.marginRight = '10px';
                    header.appendChild(totalInfo);
                }
                totalInfo.innerHTML = `<b>Obshi:</b> ${totalSht} sht / ${totalKg} kg`;
            }
            if (batches.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                totalInfo.innerHTML = `<b>Obshi:</b> 0 sht / 0 kg`;
                pagination.innerHTML = '';
                return;
            }
            emptyState.style.display = 'none';
            // Sahifalash
            const totalPages = Math.ceil(total / pageSize);
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;
            // Agar searchMode bo'lsa, backenddan kelgan natijani ko'rsatamiz, aks holda localdan bo'lamiz
            let pageBatches = batches;
            if (!searchMode) {
                const start = (currentPage - 1) * pageSize;
                const end = start + pageSize;
                pageBatches = batches.slice(start, end);
            }
            container.innerHTML = pageBatches.map(batch => {
                const maxQty = batch.quantity_sht || 0;
                const maxKg = batch.quantity_kg || 0;
                const comment = batch.comment ? `<div class='batch-comment'><strong>Izoh:</strong> ${batch.comment}</div>` : '';
                return `
                <div class="batch-item" data-id="${batch.id}">
                    <div class="batch-content">
                        <div class="batch-title">${batch.product_name}</div>
                        <div class="batch-meta">
                            <span><strong>Partiya:</strong> ${batch.batch_code}</span>
                            <span><strong>Miqdor (sht):</strong> ${maxQty}</span>
                            <span><strong>Miqdor (kg):</strong> ${maxKg}</span>
                            <span><strong>Joy:</strong> ${batch.location}</span>
                        </div>
                        ${comment}
                    </div>
                    <div class="batch-actions">
                        <button class="btn-slide" onclick="openRemoveModal(${batch.id}, '${batch.product_name.replace(/'/g, '\'')}', '${batch.batch_code}', ${maxQty}, ${maxKg})"><svg width='20' height='20' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg' style='vertical-align:middle;'><rect width='24' height='24' fill='none'/><path d='M7 12h10M13 8l4 4-4 4' stroke='#fff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/></svg></button>
                    </div>
                </div>
                `;
            }).join('');
            // Sahifa tugmalari
            let pagHtml = '';
            if (totalPages > 1) {
                // Pagination in groups of 10
                let groupSize = 10;
                let currentGroup = Math.floor((currentPage - 1) / groupSize);
                let startPage = currentGroup * groupSize + 1;
                let endPage = Math.min(startPage + groupSize - 1, totalPages);
                // Left arrow
                if (startPage > 1) {
                    pagHtml += `<button onclick="gotoPage(${startPage - 1}, ${searchMode})" style="padding: 4px 10px; margin: 0 2px; border-radius: 4px; border: 1px solid #dedede; background: #fff; color: #333; font-weight: normal; cursor:pointer;">&#8592;</button>`;
                }
                // Page buttons
                for (let i = startPage; i <= endPage; i++) {
                    pagHtml += `<button onclick="gotoPage(${i}, ${searchMode})" style="padding: 4px 10px; margin: 0 2px; border-radius: 4px; border: 1px solid #dedede; background: ${i === currentPage ? '#e04a6a' : '#fff'}; color: ${i === currentPage ? '#fff' : '#333'}; font-weight: ${i === currentPage ? 'bold' : 'normal'}; cursor:pointer;">${i}</button>`;
                }
                // Right arrow
                if (endPage < totalPages) {
                    pagHtml += `<button onclick="gotoPage(${endPage + 1}, ${searchMode})" style="padding: 4px 10px; margin: 0 2px; border-radius: 4px; border: 1px solid #dedede; background: #fff; color: #333; font-weight: normal; cursor:pointer;">&#8594;</button>`;
                }
            }
            pagination.innerHTML = pagHtml;
        }

        function gotoPage(page) {
            currentPage = page;
            renderBatchesPage();
        }
        
        // ==================== ADD BATCH ====================
        async function addBatch(e) {
            e.preventDefault();

            const data = {
                product_name: document.getElementById('productName').value,
                batch_code: document.getElementById('batchCode').value,
                quantity_sht: parseInt(document.getElementById('quantity_sht').value) || 0,
                quantity_kg: parseFloat(document.getElementById('quantity_kg').value) || 0,
                location: document.getElementById('location').value,
                comment: document.getElementById('comment').value || ''
            };

            try {
                const response = await fetchWithAuth('/api/batches', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                if (!response) return;
                let result = null;
                try {
                    result = await response.json();
                } catch (jsonErr) {
                    // JSON emas (masalan, HTML) bo'lsa, foydalanuvchiga xato yozuvini ko'rsatamiz
                    showAlert('addAlert', '‚ùå Xato: Serverdan noto‚Äòg‚Äòri javob keldi yoki sessiya tugagan!', 'error');
                    return;
                }
                if (response.ok) {
                    showAlert('addAlert', '‚úÖ Partiya muvaffaqiyatli qo\'shildi!', 'success');
                    document.getElementById('addBatchForm').reset();
                    document.getElementById('adminSection').classList.remove('show');
                    document.getElementById('overlay').classList.remove('show');
                        // Katakni band qilish (qizil qilish)
                        setCellBusy(data.location);
                    setTimeout(loadBatches, 500);
                } else {
                    showAlert('addAlert', '‚ùå Xato: ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('addAlert', '‚ùå Xato: ' + error.message, 'error');
            }
        }
        
        // ==================== REMOVE BATCH (SLIDE) ====================
        // Modal orqali chiqarish
        let removeModalBatchId = null;
        let removeModalMaxQty = 1;
        window.removeModalMaxKg = 0;
        function openRemoveModal(batchId, productName, batchCode, maxQty, maxKg) {
            removeModalBatchId = batchId;
            removeModalMaxQty = maxQty;
            window.removeModalMaxKg = maxKg;
            document.getElementById('removeModalInfo').innerHTML = `<b>${productName}</b> (<b>Kod:</b> ${batchCode})<br><b>Mavjud:</b> ${maxQty} dona<br><b>Mavjud:</b> ${maxKg} kg`;
            const qtyInput = document.getElementById('removeQtyInput');
            qtyInput.value = '';
            qtyInput.max = maxQty;
            qtyInput.min = 0;
            const kgInput = document.getElementById('removeKgInput');
            kgInput.value = '';
            kgInput.max = maxKg;
            kgInput.min = 0;
            const overlay = document.getElementById('overlay');
            if (overlay) overlay.classList.add('show');
            document.getElementById('removeModal').classList.add('show');
        }
        document.getElementById('closeRemoveModal').onclick = function() {
            document.getElementById('removeModal').classList.remove('show');
            const overlay = document.getElementById('overlay');
            if (overlay) overlay.classList.remove('show');
        };
        // Overlay and modal close logic for remove modal
        const overlay = document.getElementById('overlay');
        if (overlay) {
            overlay.addEventListener('click', function() {
                document.getElementById('removeModal').classList.remove('show');
                overlay.classList.remove('show');
            });
        }
        window.addEventListener('click', function(e) {
            const modal = document.getElementById('removeModal');
            if (e.target === modal) {
                modal.classList.remove('show');
                const overlay = document.getElementById('overlay');
                if (overlay) overlay.classList.remove('show');
            }
        });
        document.getElementById('removeForm').onsubmit = async function(e) {
            e.preventDefault();
            const qtySht = parseInt(document.getElementById('removeQtyInput').value) || 0;
            const qtyKg = parseFloat(document.getElementById('removeKgInput').value) || 0;
            if (qtySht < 0 || qtySht > removeModalMaxQty) {
                showAlert('batchesAlert', `‚ùå To'g'ri dona miqdor kiriting (0-${removeModalMaxQty})`, 'error');
                return;
            }
            if (qtyKg < 0 || qtyKg > window.removeModalMaxKg) {
                showAlert('batchesAlert', `‚ùå To'g'ri kg miqdor kiriting (0-${window.removeModalMaxKg})`, 'error');
                return;
            }
            if (qtySht === 0 && qtyKg === 0) {
                showAlert('batchesAlert', '‚ùå Kamida bitta miqdor kiriting', 'error');
                return;
            }
            const item = document.querySelector(`[data-id="${removeModalBatchId}"]`);
            item.classList.add('sliding');
            document.getElementById('removeModal').classList.remove('show');
            const overlay = document.getElementById('overlay');
            if (overlay) overlay.classList.remove('show');
            setTimeout(async () => {
                try {
                    const response = await fetchWithAuth(`/api/batches/${removeModalBatchId}/remove`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ quantity_sht: qtySht, quantity_kg: qtyKg })
                    });
                    if (!response) {
                        item.classList.remove('sliding');
                        return;
                    }
                    if (response.ok) {
                        showAlert('batchesAlert', '‚úÖ Partiya chiqarildi', 'success');
                            // Agar butunlay chiqarilsa, katakni bo'shatish (yashil qilish)
                            if ((qtySht === removeModalMaxQty || removeModalMaxQty === 0) && (qtyKg === window.removeModalMaxKg || window.removeModalMaxKg === 0)) {
                                // batch obyektidan location olish kerak, uni backenddan qaytarish yoki oldindan saqlash mumkin
                                // Bu yerda soddaroq variant: batch obyektidan location olish uchun allBatches dan topamiz
                                const batch = allBatches.find(b => b.id === removeModalBatchId);
                                if (batch && batch.location) {
                                    setCellFree(batch.location);
                                }
                            }
                        setTimeout(loadBatches, 500);
                    } else {
                        let result = {};
                        try {
                            result = await response.json();
                        } catch (err) {}
                        showAlert('batchesAlert', '‚ùå Xato! ' + (result.error || ''), 'error');
                        item.classList.remove('sliding');
                    }
                } catch (error) {
                    showAlert('batchesAlert', '‚ùå Xato: ' + error.message, 'error');
                    item.classList.remove('sliding');
                }
            }, 300);
        };
        
        // ==================== SEARCH ====================
        document.getElementById('searchInput').addEventListener('input', async (e) => {
            const query = e.target.value.trim();
            searchQuery = query;
            if (!query) {
                searchMode = false;
                currentPage = 1;
                renderBatchesPage();
                return;
            }
            searchMode = true;
            currentPage = 1;
            await fetchAndRenderSearch();
        });

        async function fetchAndRenderSearch() {
            const response = await fetchWithAuth(`/api/batches/search?q=${encodeURIComponent(searchQuery)}&page=${currentPage}&page_size=${pageSize}`);
            if (!response) return;
            const data = await response.json();
            searchResults = data.results || [];
            searchTotal = data.total || 0;
            renderBatchesPage(searchResults, searchTotal);
        }

        function gotoPage(page, isSearch) {
            currentPage = page;
            if (searchMode) {
                fetchAndRenderSearch();
            } else {
                renderBatchesPage();
            }
        }
        
        // ==================== ALERTS ====================
        function showAlert(elementId, message, type) {
            const alert = document.getElementById(elementId);
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>
